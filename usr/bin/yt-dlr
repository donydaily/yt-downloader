#!/usr/bin/env python3

import sys
import os
import uuid
from PyQt5.QtWidgets import (
    QApplication, QWidget, QVBoxLayout, QLineEdit, QPushButton,
    QLabel, QComboBox, QMessageBox, QProgressBar, QTextEdit
)
from PyQt5.QtCore import Qt, QThread, pyqtSignal
from PyQt5 import QtGui
from yt_dlp import YoutubeDL

# Folder tujuan otomatis
DOWNLOAD_DIR = os.path.expanduser('~/Downloads/yt-dlr/')
os.makedirs(DOWNLOAD_DIR, exist_ok=True)

HISTORY_FILE = os.path.join(DOWNLOAD_DIR, 'history.txt')

class DownloadThread(QThread):
    progress = pyqtSignal(str)
    finished = pyqtSignal(str)

    def __init__(self, url, format_choice, quality):
        super().__init__()
        self.url = url
        self.format_choice = format_choice
        self.quality = quality

    def run(self):
        try:
            self.progress.emit(f"Mengambil informasi: {self.url}")
            ydl_opts = {
                'quiet': True,
                'outtmpl': os.path.join(DOWNLOAD_DIR, f"%(title).200B.%(ext)s"),
                'progress_hooks': [self.hook],
                'noplaylist': True
            }

            if "Audio" in self.format_choice:
                ydl_opts.update({
                    'format': 'bestaudio/best',
                    'postprocessors': [{
                        'key': 'FFmpegExtractAudio',
                        'preferredcodec': 'mp3',
                        'preferredquality': '192',
                    }]
                })
            else:
                fmt = f'bestvideo[height<={self.quality}]+bestaudio/best'
                ydl_opts.update({
                    'format': fmt,
                    'merge_output_format': 'mp4'
                })

            with YoutubeDL(ydl_opts) as ydl:
                info = ydl.extract_info(self.url, download=True)
                title = info.get('title', 'Unknown')
                with open(HISTORY_FILE, 'a') as f:
                    f.write(f"{title} - {self.url}\n")
                self.progress.emit(f"Selesai: {title}")
        except Exception as e:
            self.progress.emit(f"Gagal: {self.url} ({str(e)})")
        self.finished.emit("Unduhan selesai.")

    def hook(self, d):
        if d['status'] == 'downloading':
            percent = d.get('_percent_str', '').strip()
            speed = d.get('_speed_str', '').strip()
            eta = d.get('eta', 0)
            self.progress.emit(f"[download] {percent} at {speed} ETA {eta}s")
        elif d['status'] == 'finished':
            self.progress.emit("[download] Menggabungkan...")

class YouTubeDownloader(QWidget):
    def __init__(self):
        super().__init__()
        self.setWindowTitle('YouTube Downloader')
        self.resize(500, 400)

        layout = QVBoxLayout()

        self.url_input = QLineEdit(self)
        self.url_input.setPlaceholderText('Masukkan URL YouTube')
        layout.addWidget(self.url_input)

        self.format_combo = QComboBox(self)
        self.format_combo.addItems(['Video (MP4)', 'Audio (MP3)'])
        layout.addWidget(self.format_combo)

        self.quality_combo = QComboBox(self)
        self.quality_combo.addItems(['144', '360', '480', '720', '1080'])
        self.quality_combo.setCurrentText('720')
        layout.addWidget(self.quality_combo)

        self.download_btn = QPushButton('Download', self)
        self.download_btn.clicked.connect(self.download_video)
        layout.addWidget(self.download_btn)

        self.progress_bar = QProgressBar(self)
        self.progress_bar.setMaximum(0)
        self.progress_bar.setVisible(False)
        layout.addWidget(self.progress_bar)

        self.status_label = QLabel('', self)
        layout.addWidget(self.status_label)

        self.log_output = QTextEdit(self)
        self.log_output.setReadOnly(True)
        layout.addWidget(self.log_output)

        self.setLayout(layout)

    def download_video(self):
        url = self.url_input.text().strip()
        if not url:
            QMessageBox.warning(self, "Error", "URL tidak boleh kosong")
            return

        format_choice = self.format_combo.currentText()
        quality = self.quality_combo.currentText()

        self.progress_bar.setVisible(True)
        self.status_label.setText("Memulai unduhan...")
        self.download_btn.setEnabled(False)
        self.log_output.clear()

        self.thread = DownloadThread(url, format_choice, quality)
        self.thread.progress.connect(self.update_status)
        self.thread.finished.connect(self.download_finished)
        self.thread.start()

    def update_status(self, message):
        self.log_output.append(message)
        self.log_output.moveCursor(QtGui.QTextCursor.End)

    def download_finished(self, message):
        self.progress_bar.setVisible(False)
        self.download_btn.setEnabled(True)
        self.status_label.setText(message)
        QMessageBox.information(self, "Selesai", message)

if __name__ == '__main__':
    app = QApplication(sys.argv)

    # Load QSS theme
    with open("/usr/share/themes/YT-Downloader/dark_theme.qss", "r") as f:
        app.setStyleSheet(f.read())

    window = YouTubeDownloader()
    window.show()
    sys.exit(app.exec_())
